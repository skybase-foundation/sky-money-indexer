# Sky Subgraph (Envio HyperIndex)

Blockchain indexer for the Sky Protocol (formerly MakerDAO) using [Envio HyperIndex](https://docs.envio.dev). Indexes governance, delegation, rewards, seal/staking, savings, token migration, and PSM events across multiple chains.

## Commands

- `pnpm codegen` — Regenerate types from `config.yaml` + `schema.graphql`
- `pnpm dev` — Start local indexer with Docker
- `pnpm start` / `pnpm stop` — Start/stop production indexer
- `pnpm tsc --noEmit` — Type check without emitting
- `pnpm test` — Run tests with vitest

Always run `pnpm codegen` after changing `schema.graphql` or `config.yaml`.

## Architecture

- **Framework**: Envio HyperIndex v2 (TypeScript handlers, not AssemblyScript)
- **Schema**: `schema.graphql` — ~91 entity types with `@derivedFrom` reverse lookups and `@index` directives
- **Config**: `config.yaml` — Contract definitions, ABIs, event signatures, and chain configuration
- **Handlers**: `src/*.ts` — One file per contract/feature. Registered via `ContractName.EventName.handler()`
- **Helpers**: `src/helpers/` — Shared logic (entity creation, delegation handlers, contract calls via viem)
- **Contract calls**: `src/helpers/contractCalls.ts` — On-chain reads using `viem` (replaces The Graph's `Contract.bind()`)
- **Dynamic contracts**: Delegate factories use `contractRegister` for runtime contract registration
- **Generated code**: `generated/` — Auto-generated by `pnpm codegen`, do not edit

## Key Patterns

### Entity IDs
All entity IDs are prefixed with `chainId-` to prevent collisions across chains:
```typescript
const id = `${event.chainId}-${event.params.pollId.toString()}`;
```

### Entity operations
```typescript
// Load
const entity = await context.Entity.get(id);
// Save
context.Entity.set({ id, chainId: event.chainId, field: value });
```

### Handler registration
```typescript
ContractName.EventName.handler(async ({ event, context }) => {
  // handler logic
});
```

### Address normalization
All addresses stored as lowercase strings. Use `.toLowerCase()` when comparing.

## Multichain

Indexes 5+ networks: Ethereum mainnet (1), Base (8453), Optimism (10), Arbitrum (42161), Unichain (130). Tenderly fork supported via RPC fallback. Each entity has a `chainId: Int! @index` field for filtering.

## Schema Conventions

- `chainId: Int! @index` on every entity
- `@index` on high-value address lookup fields (`owner`, `user`, `usr`, `delegator`, `sender`, `ownerAddress`)
- `@derivedFrom` for reverse lookups (virtual fields, not stored in handlers)
- `BigInt` for token amounts and timestamps
- `BigDecimal` only for normalized display values
- Entity references use `field_id: String` pattern (Envio convention)
